<!doctype html>
<html>
<head>
  <title>数据清理</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="p-4">
  <h1>数据清理</h1>
  <a href="/" class="btn btn-secondary mb-3">返回首页</a>
  
  <div class="card mb-4">
    <div class="card-header">
      数据统计
    </div>
    <div class="card-body">
      <p>最早数据日期: {% if oldest_date %}{{ oldest_date.strftime('%Y-%m-%d %H:%M:%S') }}{% else %}无数据{% endif %}</p>
      <p>最新数据日期: {% if newest_date %}{{ newest_date.strftime('%Y-%m-%d %H:%M:%S') }}{% else %}无数据{% endif %}</p>
      <p>总数据条数: {{ total_count }}</p>
      <p class="text-danger">超过30天的旧数据条数: {{ old_count }}</p>
    </div>
  </div>
  
  <div class="card">
    <div class="card-header">
      清理操作
    </div>
    <div class="card-body">
      <p class="card-text">此操作将删除所有超过30天的MAC地址数据，此操作不可逆。</p>
      <button id="cleanupBtn" class="btn btn-danger">清理旧数据</button>
    </div>
  </div>
  
  <div id="taskStatus" class="alert alert-info d-none mt-3" role="alert">
    <!-- 任务状态将在这里显示 -->
  </div>
  
  <script>
    document.getElementById('cleanupBtn').addEventListener('click', function() {
      if (!confirm('确定要清理超过30天的旧数据吗？此操作不可撤销！')) {
        return;
      }
      
      const statusDiv = document.getElementById('taskStatus');
      
      statusDiv.classList.remove('d-none');
      statusDiv.classList.remove('alert-success', 'alert-danger');
      statusDiv.classList.add('alert-info');
      statusDiv.innerHTML = '开始清理数据，请稍候...';
      
      fetch('/cleanup', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // 轮询任务状态
          const taskId = data.task_id;
          checkTaskStatus(taskId);
        } else {
          statusDiv.classList.remove('alert-info');
          statusDiv.classList.add('alert-danger');
          statusDiv.innerHTML = `错误: ${data.error}`;
        }
      })
      .catch(error => {
        statusDiv.classList.remove('alert-info');
        statusDiv.classList.add('alert-danger');
        statusDiv.innerHTML = `请求失败: ${error}`;
      });
    });
    
    function checkTaskStatus(taskId) {
      const statusDiv = document.getElementById('taskStatus');
      
      fetch(`/task_status/${taskId}`)
      .then(response => response.json())
      .then(data => {
        if (data.status === 'completed') {
          statusDiv.classList.remove('alert-info');
          statusDiv.classList.add('alert-success');
          statusDiv.innerHTML = `清理完成: ${data.message}`;
          // 刷新页面以更新统计信息
          setTimeout(() => location.reload(), 2000);
        } else if (data.status === 'failed') {
          statusDiv.classList.remove('alert-info');
          statusDiv.classList.add('alert-danger');
          statusDiv.innerHTML = `清理失败: ${data.message}`;
        } else {
          // 仍在运行，继续轮询
          statusDiv.innerHTML = `清理中: ${data.message}`;
          setTimeout(() => checkTaskStatus(taskId), 2000);
        }
      })
      .catch(error => {
        statusDiv.classList.remove('alert-info');
        statusDiv.classList.add('alert-danger');
        statusDiv.innerHTML = `获取任务状态失败: ${error}`;
      });
    }
  </script>
</body>
</html>