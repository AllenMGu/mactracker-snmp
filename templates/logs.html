<!doctype html>
<html>
<head>
  <title>采集日志</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <meta http-equiv="refresh" content="30">
  <style>
    .pagination {
      margin: 0;
    }
    .page-size-select {
      width: auto;
      display: inline-block;
    }
  </style>
</head>
<body class="p-4">
  <h1>采集日志</h1>
  <a href="/" class="btn btn-secondary mb-3">返回首页</a>
  
  <!-- 筛选表单 -->
  <form method="get" action="/logs" class="mb-4">
    <div class="row">
      <div class="col-md-3">
        <label for="dateSelect" class="form-label">筛选日期</label>
        <select class="form-select" id="dateSelect" name="date">
          <option value="">-- 所有日期 --</option>
          {% for date in log_dates %}
          <option value="{{ date }}" {% if date == selected_date %}selected{% endif %}>
            {{ date }}
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label for="perPageSelect" class="form-label">每页显示</label>
        <select class="form-select" id="perPageSelect" name="per_page" onchange="this.form.submit()">
          <option value="20" {% if per_page == 20 %}selected{% endif %}>20 条</option>
          <option value="50" {% if per_page == 50 %}selected{% endif %}>50 条</option>
          <option value="100" {% if per_page == 100 %}selected{% endif %}>100 条</option>
          <option value="200" {% if per_page == 200 %}selected{% endif %}>200 条</option>
        </select>
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <button type="submit" class="btn btn-primary">应用筛选</button>
        <a href="/logs" class="btn btn-outline-secondary ms-2">重置</a>
      </div>
    </div>
  </form>
  
  <!-- 日志统计信息 -->
  <div class="alert alert-info">
    共 {{ total_count }} 条日志记录，当前显示第 {{ (page-1)*per_page+1 }} 到 {{ [page*per_page, total_count]|min }} 条
    {% if selected_date %}
    （筛选日期: {{ selected_date }}）
    {% endif %}
  </div>
  
  <!-- 日志表格 -->
  <table class="table table-striped">
    <thead>
      <tr><th>时间</th><th>消息</th></tr>
    </thead>
    <tbody>
      {% for log in logs %}
      <tr>
        <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
        <td>{{ log.message }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  
  <!-- 分页控件 -->
  {% if total_pages > 1 %}
  <nav aria-label="日志分页">
    <ul class="pagination">
      <!-- 上一页 -->
      <li class="page-item {% if page == 1 %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('logs', page=page-1, per_page=per_page, date=selected_date) }}">上一页</a>
      </li>
      
      <!-- 页码 -->
      {% for p in range(1, total_pages + 1) %}
        {% if p == page %}
          <li class="page-item active"><span class="page-link">{{ p }}</span></li>
        {% elif p >= page-2 and p <= page+2 %}
          <li class="page-item"><a class="page-link" href="{{ url_for('logs', page=p, per_page=per_page, date=selected_date) }}">{{ p }}</a></li>
        {% elif p == 1 or p == total_pages %}
          <li class="page-item"><a class="page-link" href="{{ url_for('logs', page=p, per_page=per_page, date=selected_date) }}">{{ p }}</a></li>
        {% elif p == page-3 or p == page+3 %}
          <li class="page-item disabled"><span class="page-link">...</span></li>
        {% endif %}
      {% endfor %}
      
      <!-- 下一页 -->
      <li class="page-item {% if page == total_pages %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('logs', page=page+1, per_page=per_page, date=selected_date) }}">下一页</a>
      </li>
    </ul>
  </nav>
  {% endif %}
  
  <!-- 自动刷新控制 -->
  <div class="mt-3">
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
      <label class="form-check-label" for="autoRefresh">自动刷新 (10秒)</label>
    </div>
  </div>
  
  <script>
    // 自动刷新控制
    document.getElementById('autoRefresh').addEventListener('change', function() {
      if (this.checked) {
        // 启用自动刷新
        if (!window.refreshInterval) {
          window.refreshInterval = setInterval(function() {
            window.location.reload();
          }, 10000);
        }
      } else {
        // 禁用自动刷新
        if (window.refreshInterval) {
          clearInterval(window.refreshInterval);
          window.refreshInterval = null;
        }
      }
    });
    
    // 初始化自动刷新
    window.refreshInterval = setInterval(function() {
      window.location.reload();
    }, 10000);
  </script>
</body>
</html>